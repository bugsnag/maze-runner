steps:
  - label: ':docker: Build'
    plugins:
      - docker-compose#v2.5.1:
          build: ci
          image-repository: 855461928731.dkr.ecr.us-west-1.amazonaws.com/maze-runner
          cache-from: ci:855461928731.dkr.ecr.us-west-1.amazonaws.com/maze-runner:${BRANCH_NAME:-[v1]}-ci
      - docker-compose#v2.5.1:
          push:
            - ci:855461928731.dkr.ecr.us-west-1.amazonaws.com/maze-runner:v1-ci
            - ci:855461928731.dkr.ecr.us-west-1.amazonaws.com/maze-runner:${BRANCH_NAME}-ci

  - wait

  - label: 'Unit tests'
    plugins:
      docker-compose#v2.5.1:
        run: ci
    command: 'bundle exec rake'

  - wait

  - label: 'Release'
    plugins:
      - docker-compose#v2.5.1:
          build: cli
          cache-from: cli:855461928731.dkr.ecr.us-west-1.amazonaws.com/maze-runner:${BRANCH_NAME:-[v1]}-cli
      - docker-compose#v2.5.1:
          push:
            - cli:855461928731.dkr.ecr.us-west-1.amazonaws.com/maze-runner:v1-cli
            - cli:855461928731.dkr.ecr.us-west-1.amazonaws.com/maze-runner:${BRANCH_NAME}-cli
